<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>TradingSignal</title>
    <link rel="icon" type="image/x-icon" href="../img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/lightweight-charts.standalone.production.js"></script>
</head>
<body>
<h1>Trading Chart</h1>
<h2 th:text="'Pair: ' + ${symbol} +' on ' + ${interval} + ' interval'"></h2>
<div id="chart" style="width: 800px; height: 400px;"></div>
<script th:inline="javascript">
    // https://github.com/tradingview/lightweight-charts
    // https://tradingview.github.io/lightweight-charts/tutorials

    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        width: 800,
        height: 400,
        layout: {
            background: { color: "#222" },
            textColor: "#DDDDDD",
        },
        grid: {
            vertLines: { color: "#444" },
            horzLines: { color: "#444" },
        },
        rightPriceScale: {
            borderVisible: false,
        },
        timeScale: {
            rightOffset: 12,
            barSpacing: 3,
            timeVisible: true,
            secondsVisible: false,
            lockVisibleTimeRangeOnResize: true,
            borderVisible: false,
        },
    });

    // Candle configurate
    const candleSeries = chart.addCandlestickSeries({
        upColor: '#4caf50',// Bullish candles (up :D)
        borderUpColor: '#4caf50',
        wickUpColor: '#4caf50',
        downColor: '#f44336', // Bearish candles (down :D)
        borderDownColor: '#f44336',
        wickDownColor: '#f44336'
    });

    // Adding historical data to chart
    const historicalData = /*[[${historicalData}]]*/ [];
    const formattedData = historicalData.map(entry => ({
        time: Math.floor(entry[0] / 1000), // Convert time from milliseconds to seconds
        open: parseFloat(entry[1]),
        high: parseFloat(entry[2]),
        low: parseFloat(entry[3]),
        close: parseFloat(entry[4])
    }));
    candleSeries.setData(formattedData); // Setting data to candlestick chart

    // WebSocket - Live data added to chart
    const pair = /*[[${pair}]]*/ '';
    const interval = /*[[${interval}]]*/ '';

    // Available interval: 1s 1m 3m 5m 15m 30m 1h 2h 4h 6h 8h 12h 1d 3d 1w 1M

    const socket = new WebSocket('wss://stream.binance.com:9443/ws/' + pair.toLowerCase() + '@kline_' + interval);

    socket.onmessage = event => {
        const message = JSON.parse(event.data);

        const newCandle = {
            time: message.k.t / 1000, // Milisekundy na sekundy
            open: parseFloat(message.k.o),
            high: parseFloat(message.k.h),
            low: parseFloat(message.k.l),
            close: parseFloat(message.k.c),
        };
        candleSeries.update(newCandle);
    };
</script>
</body>
</html>
